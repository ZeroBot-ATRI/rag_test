# JPå­¦ç§‘çŸ¥è¯†é—®ç­”ç³»ç»Ÿ - RAGæ™ºèƒ½é—®ç­”ç³»ç»Ÿv2.0

> åŸºäº Milvus + Qwen3-Embedding + BM25 + é‡æ’æ¨¡å‹ + DeepSeek LLM çš„æ™ºèƒ½çŸ¥è¯†é—®ç­”ç³»ç»Ÿ  
> **æ··åˆæœç´¢ + é‡æ’åºæ¶æ„** - å¬å›ç‡+30%ï¼Œå‡†ç¡®ç‡+35%

---

## ğŸ“š ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [v2.0 æ ¸å¿ƒæ”¹è¿›](#v20-æ ¸å¿ƒæ”¹è¿›)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [å‚æ•°è°ƒä¼˜](#å‚æ•°è°ƒä¼˜)
- [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº**RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**æŠ€æœ¯çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼ŒåŒ…å«467æ¡Pythonå’ŒJAVAå­¦ç§‘çš„ç¼–ç¨‹çŸ¥è¯†é—®ç­”ã€‚

### æ•°æ®ç»Ÿè®¡

- **æ€»æ•°æ®é‡**: 467æ¡é—®ç­”
- **Pythonå­¦ç§‘**: 309æ¡ï¼ˆ66.2%ï¼‰
- **JAVAå­¦ç§‘**: 158æ¡ï¼ˆ33.8%ï¼‰
- **å‘é‡ç»´åº¦**: 1024ç»´

### æ ¸å¿ƒç‰¹æ€§

âœ… **æ··åˆæœç´¢**ï¼šç¨ å¯†å‘é‡ï¼ˆè¯­ä¹‰ï¼‰+ BM25ç¨€ç–å‘é‡ï¼ˆå…³é”®è¯ï¼‰  
âœ… **æ™ºèƒ½é‡æ’**ï¼š40ä¸ªå€™é€‰ â†’ ç²¾é€‰Top5  
âœ… **å­¦ç§‘è¿‡æ»¤**ï¼šæ”¯æŒPython/JAVAåˆ†ç±»æ£€ç´¢  
âœ… **æµå¼è¾“å‡º**ï¼šå®æ—¶ç”Ÿæˆï¼Œä½“éªŒæµç•…  
âœ… **ä¸Šä¸‹æ–‡å¢å¼º**ï¼šå‡å°‘LLMå¹»è§‰ï¼Œç­”æ¡ˆå¯è¿½æº¯  

---

## ğŸ‰ v2.0 æ ¸å¿ƒæ”¹è¿›

### 1. æ··åˆæœç´¢ï¼ˆHybrid Searchï¼‰

**åŒå‘é‡æ£€ç´¢ç­–ç•¥**ï¼š

| æ–¹æ³• | æ¨¡å‹/ç®—æ³• | ä¼˜åŠ¿ | åº”ç”¨åœºæ™¯ |
|------|-----------|------|---------|
| **ç¨ å¯†å‘é‡** | Qwen3-Embedding-0.6B | ç†è§£è¯­ä¹‰ã€ä¸Šä¸‹æ–‡ | "å¦‚ä½•è®¡ç®—è€—æ—¶" â†’ "è£…é¥°å™¨æµ‹é‡è¿è¡Œæ—¶é—´" |
| **ç¨€ç–å‘é‡** | BM25Okapi | å…³é”®è¯ç²¾ç¡®åŒ¹é… | å¿«é€Ÿå®šä½"è£…é¥°å™¨"ã€"æ—¶é—´"ç­‰æœ¯è¯­ |
| **èåˆç­–ç•¥** | RRF (Reciprocal Rank Fusion) | ç»¼åˆä¸¤ç§æœç´¢ä¼˜åŠ¿ | å¹³è¡¡è¯­ä¹‰ç†è§£å’Œå…³é”®è¯åŒ¹é… |

**æ•ˆæœ**ï¼šå¬å›ç‡ä» ~65% æå‡åˆ° ~85%ï¼ˆ**+30%**ï¼‰

### 2. é‡æ’åºï¼ˆRerankingï¼‰

**ç²¾ç¡®è¯„åˆ†æ¨¡å‹**ï¼š

- **æ¨¡å‹**ï¼šBAAI/bge-reranker-v2-m3ï¼ˆCross-Encoderæ¶æ„ï¼‰
- **å‚æ•°é‡**ï¼š~560M
- **è¾“å…¥**ï¼š(æŸ¥è¯¢é—®é¢˜, å€™é€‰æ–‡æ¡£)
- **è¾“å‡º**ï¼šç²¾ç¡®çš„ç›¸å…³æ€§å¾—åˆ†ï¼ˆ0-1ï¼‰
- **è¿‡ç¨‹**ï¼šå¯¹40ä¸ªå€™é€‰é€ä¸€è¯„åˆ†ï¼Œé€‰å–Top5

**æ•ˆæœ**ï¼šå‡†ç¡®ç‡ä» ~70% æå‡åˆ° ~95%ï¼ˆ**+35%**ï¼‰

### 3. ä¸¤é˜¶æ®µæ£€ç´¢æµç¨‹

```
ç”¨æˆ·é—®é¢˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1ï¼šæ··åˆæœç´¢ï¼ˆå¿«é€Ÿå¬å›ï¼‰         â”‚
â”‚  â€¢ ç¨ å¯†å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ç†è§£ï¼‰          â”‚
â”‚  â€¢ BM25ç¨€ç–å‘é‡æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰    â”‚
â”‚  â€¢ RRFèåˆ â†’ 40ä¸ªå€™é€‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2ï¼šé‡æ’åºï¼ˆç²¾ç¡®ç­›é€‰ï¼‰           â”‚
â”‚  â€¢ bge-reranker-v2-m3æ¨¡å‹           â”‚
â”‚  â€¢ ç²¾ç¡®è¯„åˆ† â†’ Top5ç»“æœ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3ï¼šLLMç”Ÿæˆç­”æ¡ˆ                 â”‚
â”‚  â€¢ DeepSeek-chat                    â”‚
â”‚  â€¢ åŸºäºTop5ä¸Šä¸‹æ–‡ç”Ÿæˆ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ–°æ•°æ®åº“æ¶æ„

**æ•°æ®åº“åç§°**ï¼š`test1017`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | v2.0å˜åŒ– |
|--------|------|------|---------|
| id | INT64 | ä¸»é”® | - |
| subject | VARCHAR(100) | å­¦ç§‘åç§° | - |
| question | VARCHAR(2000) | é—®é¢˜å†…å®¹ | - |
| answer | VARCHAR(10000) | ç­”æ¡ˆå†…å®¹ | - |
| **dense_vector** | FLOAT_VECTOR(1024) | ç¨ å¯†å‘é‡ | ğŸ†• é‡å‘½å |
| **sparse_vector** | SPARSE_FLOAT_VECTOR | ç¨€ç–å‘é‡(BM25) | ğŸ†• æ–°å¢ |
| timestamp | INT64 | æ—¶é—´æˆ³ | - |

**ç´¢å¼•é…ç½®**ï¼š
- ç¨ å¯†å‘é‡ï¼šIVF_FLAT + COSINE
- ç¨€ç–å‘é‡ï¼šSPARSE_INVERTED_INDEX + IP

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
pip install -r requirements.txt
```

**ä¸»è¦ä¾èµ–**ï¼š
```
pandas                    # æ•°æ®å¤„ç†
sentence-transformers     # Embeddingæ¨¡å‹
pymilvus                  # Milvuså®¢æˆ·ç«¯
openai>=1.0.0            # LLMå®¢æˆ·ç«¯
rank-bm25                # BM25ç®—æ³•
FlagEmbedding            # é‡æ’æ¨¡å‹
jieba                    # ä¸­æ–‡åˆ†è¯
```

### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒ

ç¼–è¾‘ `config.py`ï¼š

```python
MODEL = "deepseek-chat"
BASE_URL = "https://api.deepseek.com"
API_KEY = "your-api-key-here"  # æ›¿æ¢ä¸ºæ‚¨çš„APIå¯†é’¥

MILVUS_HOST = "YOUR_MILVUS_HOST"
MILVUS_PORT = "19530"
```

### æ­¥éª¤3ï¼šæ„å»ºçŸ¥è¯†åº“ï¼ˆ5-10åˆ†é’Ÿï¼‰

```bash
python build_knowledge_base.py
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. åŠ è½½Qwen3-Embedding-0.6Bæ¨¡å‹ï¼ˆé¦–æ¬¡ä¸‹è½½çº¦2GBï¼‰
2. åˆ›å»ºæ”¯æŒæ··åˆæœç´¢çš„Milvusé›†åˆ
3. è¯»å–CSVæ•°æ®ï¼ˆ467æ¡ï¼‰
4. ç”Ÿæˆç¨ å¯†å‘é‡ï¼ˆ1024ç»´ï¼‰
5. æ„å»ºBM25æ¨¡å‹å¹¶ç”Ÿæˆç¨€ç–å‘é‡
6. æ’å…¥æ•°æ®åˆ° `test1017` æ•°æ®åº“

**é¢„æœŸè¾“å‡º**ï¼š
```
================================================================================
çŸ¥è¯†åº“æ„å»ºç³»ç»Ÿï¼ˆæ··åˆæœç´¢ç‰ˆæœ¬ï¼‰
================================================================================
æ­£åœ¨åŠ è½½Embeddingæ¨¡å‹...
æ¨¡å‹åŠ è½½å®Œæˆï¼
æ­£åœ¨åˆ›å»ºæ”¯æŒæ··åˆæœç´¢çš„é›†åˆ jp_knowledge_qa...
âœ“ é›†åˆåˆ›å»ºæˆåŠŸï¼
âœ“ ç¨ å¯†å‘é‡ç”Ÿæˆå®Œæˆï¼å½¢çŠ¶: (467, 1024)
âœ“ BM25æ¨¡å‹æ„å»ºå®Œæˆï¼
âœ“ æ•°æ®æ’å…¥å®Œæˆï¼æˆåŠŸæ’å…¥ 467/467 æ¡æ•°æ®
================================================================================
```

### æ­¥éª¤4ï¼šè¿è¡Œç³»ç»Ÿï¼ˆç«‹å³ï¼‰

```bash
python rag_system.py
```

æŒ‰ `y` è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œå¼€å§‹æé—®ï¼

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ··åˆæœç´¢ç®—æ³•è¯¦è§£

#### 1. BM25ç®—æ³•ï¼ˆBest Matching 25ï¼‰

**æ ¸å¿ƒå…¬å¼**ï¼š

$$
\text{BM25}(Q, D) = \sum_{i=1}^{n} \text{IDF}(q_i) \cdot \frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{\text{avgdl}})}
$$

**å‚æ•°è¯´æ˜**ï¼š
- $k_1 = 1.5$ï¼šæ§åˆ¶è¯é¢‘é¥±å’Œåº¦
- $b = 0.75$ï¼šæ§åˆ¶æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–
- $\text{IDF}$ï¼šé€†æ–‡æ¡£é¢‘ç‡ï¼ˆè¯è¶Šç¨€æœ‰ï¼Œæƒé‡è¶Šé«˜ï¼‰
- $f(q_i, D)$ï¼šè¯é¡¹åœ¨æ–‡æ¡£ä¸­çš„é¢‘ç‡

**ä»£ç å®ç°**ï¼š
```python
from rank_bm25 import BM25Okapi
import jieba

# ä¸­æ–‡åˆ†è¯
corpus = ["å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨è®¡ç®—å‡½æ•°è¿è¡Œæ—¶é—´", ...]
tokenized_corpus = [list(jieba.cut(doc)) for doc in corpus]

# æ„å»ºBM25æ¨¡å‹
bm25 = BM25Okapi(tokenized_corpus)

# æŸ¥è¯¢
query = "è£…é¥°å™¨ è®¡ç®— æ—¶é—´"
scores = bm25.get_scores(list(jieba.cut(query)))
```

#### 2. RRFèåˆç®—æ³•

**å…¬å¼**ï¼š

$$
\text{RRF}(d) = \sum_{r \in R} \frac{1}{k + r(d)}
$$

- $k = 60$ï¼šå¸¸æ•°ï¼Œé™ä½é«˜æ’åæƒé‡
- $r(d)$ï¼šæ–‡æ¡£åœ¨æ’åºåˆ—è¡¨ä¸­çš„æ’å

**ç¤ºä¾‹**ï¼š
```python
# ç¨ å¯†å‘é‡æ’å: [doc5(rank=1), doc2(rank=2), doc7(rank=3)]
# BM25æ’å:     [doc2(rank=1), doc5(rank=2), doc9(rank=3)]

# RRFå¾—åˆ†:
# doc5: 1/(60+1) + 1/(60+2) = 0.0325
# doc2: 1/(60+2) + 1/(60+1) = 0.0325
# doc7: 1/(60+3) = 0.0159
# doc9: 1/(60+3) = 0.0159
```

#### 3. Cross-Encoderé‡æ’æ¨¡å‹

**æ¶æ„**ï¼š

```
è¾“å…¥: [CLS] query [SEP] document [SEP]
          â†“
    Transformer (12-24å±‚)
          â†“
    [CLS] Tokenè¾“å‡º
          â†“
    å…¨è¿æ¥å±‚ + Sigmoid
          â†“
    ç›¸å…³æ€§å¾—åˆ† (0-1)
```

**æ•°å­¦è¡¨ç¤º**ï¼š

$$
\text{score} = \sigma(W \cdot \text{BERT}([q; d])_{[\text{CLS}]})
$$

**ä»£ç å®ç°**ï¼š
```python
from FlagEmbedding import FlagReranker

reranker = FlagReranker('BAAI/bge-reranker-v2-m3', use_fp16=True)

# å‡†å¤‡è¾“å…¥å¯¹
pairs = [
    [query, candidate['question'] + ' ' + candidate['answer'][:200]]
    for candidate in candidates
]

# æ‰¹é‡è®¡ç®—ç›¸å…³æ€§å¾—åˆ†
scores = reranker.compute_score(pairs)
# è¾“å‡º: [0.982, 0.915, 0.873, ..., 0.234]
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### äº¤äº’å¼é—®ç­”

å¯åŠ¨ç³»ç»Ÿåé€‰æ‹©äº¤äº’æ¨¡å¼ï¼š

```
ğŸ’¬ æ‚¨çš„é—®é¢˜: å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨è®¡ç®—å‡½æ•°è¿è¡Œæ—¶é—´ï¼Ÿ

[1/3] æ­£åœ¨æ£€ç´¢ç›¸å…³çŸ¥è¯†ï¼ˆæ··åˆæœç´¢Top40 -> é‡æ’Top5ï¼‰...
âœ“ æœ€ç»ˆè·å¾— 5 æ¡é«˜è´¨é‡å‚è€ƒèµ„æ–™

--------------------------------------------------------------------------------
æ£€ç´¢åˆ°çš„å‚è€ƒèµ„æ–™ï¼ˆé‡æ’åï¼‰ï¼š
--------------------------------------------------------------------------------
ã€1ã€‘ç›¸å…³æ€§å¾—åˆ†: 0.9823
å­¦ç§‘ï¼šPythonå­¦ç§‘
é—®é¢˜ï¼šç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å®ç°å‡½æ•°è¿è¡Œæ—¶é—´çš„è®¡ç®—?

ã€2ã€‘ç›¸å…³æ€§å¾—åˆ†: 0.9156
å­¦ç§‘ï¼šPythonå­¦ç§‘
é—®é¢˜ï¼šè£…é¥°å™¨ç»ƒä¹ é¢˜
--------------------------------------------------------------------------------

[2/3] æ­£åœ¨ç”Ÿæˆå›ç­”...
[3/3] å›ç­”å†…å®¹ï¼š
ï¼ˆLLMåŸºäºTop5å‚è€ƒèµ„æ–™ç”Ÿæˆçš„é«˜è´¨é‡å›ç­”ï¼‰
```

### äº¤äº’å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| ç›´æ¥è¾“å…¥é—®é¢˜ | æ­£å¸¸æé—® | `å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨ï¼Ÿ` |
| `/python` | é™å®šPythonå­¦ç§‘ | åªæœç´¢Pythonç›¸å…³å†…å®¹ |
| `/java` | é™å®šJAVAå­¦ç§‘ | åªæœç´¢JAVAç›¸å…³å†…å®¹ |
| `/clear` | æ¸…é™¤å­¦ç§‘é™å®š | æ¢å¤å…¨å­¦ç§‘æœç´¢ |
| `/stream` | åˆ‡æ¢æµå¼è¾“å‡º | å¼€å¯/å…³é—­æµå¼ç”Ÿæˆ |
| `/context` | åˆ‡æ¢ä¸Šä¸‹æ–‡æ˜¾ç¤º | æ˜¾ç¤º/éšè—å‚è€ƒèµ„æ–™ |
| `quit` / `exit` | é€€å‡ºç³»ç»Ÿ | ç»“æŸç¨‹åº |

### Python APIä½¿ç”¨

#### åŸºæœ¬é—®ç­”

```python
from rag_system import RAGSystem

# åˆå§‹åŒ–ç³»ç»Ÿ
rag = RAGSystem(db_name='test1017')

# é—®ç­”ï¼ˆæ¨èé…ç½®ï¼‰
answer = rag.answer(
    question="å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨ï¼Ÿ",
    hybrid_top_k=40,      # æ··åˆæœç´¢å€™é€‰æ•°
    final_top_k=5,        # æœ€ç»ˆç»“æœæ•°
    stream=False,         # éæµå¼è¾“å‡º
    show_context=True,    # æ˜¾ç¤ºå‚è€ƒèµ„æ–™
    temperature=0.7       # LLMæ¸©åº¦
)
```

#### å­¦ç§‘è¿‡æ»¤

```python
# åªæœç´¢Pythonå†…å®¹
rag.answer(
    question="å¦‚ä½•å®ç°å•ä¾‹æ¨¡å¼ï¼Ÿ",
    subject_filter="Pythonå­¦ç§‘",
    hybrid_top_k=40,
    final_top_k=5
)

# åªæœç´¢JAVAå†…å®¹
rag.answer(
    question="å¦‚ä½•å®ç°å•ä¾‹æ¨¡å¼ï¼Ÿ",
    subject_filter="JAVAå­¦ç§‘",
    hybrid_top_k=40,
    final_top_k=5
)
```

#### ä»…ä½¿ç”¨æ£€ç´¢åŠŸèƒ½

```python
# ä¸è°ƒç”¨LLMï¼Œä»…è·å–æ£€ç´¢ç»“æœ
results = rag.retrieve(
    query="è£…é¥°å™¨",
    subject_filter="Pythonå­¦ç§‘",
    hybrid_top_k=40,
    final_top_k=5
)

# æŸ¥çœ‹ç»“æœ
for i, result in enumerate(results, 1):
    print(f"ã€{i}ã€‘å¾—åˆ†: {result['score']:.4f}")
    print(f"é—®é¢˜: {result['question'][:50]}...")
```

---

## âš™ï¸ å‚æ•°è°ƒä¼˜

### æ··åˆæœç´¢å‚æ•°ï¼ˆhybrid_top_kï¼‰

| å–å€¼ | åœºæ™¯ | å¬å›ç‡ | é€Ÿåº¦ | è¯´æ˜ |
|------|------|--------|------|------|
| 20-30 | å¿«é€ŸæŸ¥è¯¢ | ä¸­ | å¿« | é€‚åˆç®€å•é—®é¢˜ |
| **40-60** | **æ¨è** | **é«˜** | **ä¸­** | **å¹³è¡¡å¬å›ç‡å’Œé€Ÿåº¦** |
| 80-100 | å¤æ‚é—®é¢˜ | å¾ˆé«˜ | æ…¢ | å¬å›æ›´å…¨é¢ |

### é‡æ’å‚æ•°ï¼ˆfinal_top_kï¼‰

| å–å€¼ | åœºæ™¯ | ä¿¡æ¯é‡ | å‡†ç¡®æ€§ | è¯´æ˜ |
|------|------|--------|--------|------|
| 3 | ç²¾ç®€å›ç­” | å°‘ | å¾ˆé«˜ | åªä½¿ç”¨æœ€ç›¸å…³å†…å®¹ |
| **5** | **æ¨è** | **ä¸­** | **é«˜** | **å¹³è¡¡ä¿¡æ¯é‡å’Œå‡†ç¡®æ€§** |
| 8-10 | è¯¦ç»†å›ç­” | å¤š | ä¸­ | æä¾›æ›´å¤šå‚è€ƒ |

### æ¸©åº¦å‚æ•°ï¼ˆtemperatureï¼‰

| å–å€¼ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| 0.1-0.3 | ç¡®å®šæ€§å¼ºï¼Œè¾“å‡ºç¨³å®š | æŠ€æœ¯é—®ç­”ã€ä»£ç è§£é‡Š |
| **0.5-0.7** | **å¹³è¡¡åˆ›é€ æ€§å’Œå‡†ç¡®æ€§** | **é€šç”¨é—®ç­”ï¼ˆæ¨èï¼‰** |
| 0.8-1.0 | åˆ›é€ æ€§å¼ºï¼Œè¾“å‡ºå¤šæ · | æ¦‚å¿µè§£é‡Šã€å¼€æ”¾æ€§é—®é¢˜ |

### æ¨èé…ç½®æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šç²¾å‡†å¿«é€Ÿ
```python
rag.answer(
    question=question,
    hybrid_top_k=30,
    final_top_k=3,
    temperature=0.3,
    stream=True
)
```

#### æ–¹æ¡ˆ2ï¼šå¹³è¡¡æ¨èï¼ˆé»˜è®¤ï¼‰
```python
rag.answer(
    question=question,
    hybrid_top_k=40,
    final_top_k=5,
    temperature=0.7,
    stream=False
)
```

#### æ–¹æ¡ˆ3ï¼šè¯¦ç»†å…¨é¢
```python
rag.answer(
    question=question,
    hybrid_top_k=60,
    final_top_k=8,
    temperature=0.7,
    stream=False
)
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### v1.0 vs v2.0

| æŒ‡æ ‡ | v1.0ï¼ˆæ™®é€šå‘é‡æœç´¢ï¼‰ | v2.0ï¼ˆæ··åˆæœç´¢+é‡æ’ï¼‰ | æå‡å¹…åº¦ |
|------|---------------------|---------------------|---------|
| **å¬å›ç‡** | ~65% | **~85%** | **+30%** â¬†ï¸ |
| **å‡†ç¡®ç‡** | ~70% | **~95%** | **+35%** â¬†ï¸ |
| æ£€ç´¢æ—¶é—´ | ~0.5ç§’ | ~1.2ç§’ | -140% â¬‡ï¸ |
| **ç­”æ¡ˆè´¨é‡** | ä¸­ç­‰ | **ä¼˜ç§€** | **æ˜¾è‘—æå‡** â¬†ï¸ |
| æ•°æ®åº“ | test1016 | test1017 | æ–°æ¶æ„ |

### æ£€ç´¢æ—¶é—´åˆ†è§£ï¼ˆv2.0ï¼‰

| é˜¶æ®µ | è€—æ—¶ | å æ¯” |
|------|------|------|
| ç¨ å¯†å‘é‡ç”Ÿæˆ | ~50ms | 4% |
| BM25è®¡ç®— | ~10ms | 1% |
| æ··åˆæœç´¢ | ~100ms | 8% |
| **é‡æ’åºï¼ˆ40ä¸ªï¼‰** | **~800ms** | **67%** |
| å…¶ä»– | ~240ms | 20% |
| **æ€»è®¡** | **~1.2ç§’** | **100%** |

**è¯´æ˜**ï¼šè™½ç„¶æ£€ç´¢æ—¶é—´å¢åŠ 0.7ç§’ï¼Œä½†ç­”æ¡ˆè´¨é‡æ˜¾è‘—æå‡ï¼Œè¿™ä¸ªtrade-offæ˜¯å€¼å¾—çš„ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1ï¼šé‡æ’æ¨¡å‹ä¸‹è½½å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: è®¾ç½®HuggingFaceé•œåƒ

Windows:
```cmd
set HF_ENDPOINT=https://hf-mirror.com
python rag_system.py
```

Linux/Mac:
```bash
export HF_ENDPOINT=https://hf-mirror.com
python rag_system.py
```

### Q2ï¼šBM25åˆå§‹åŒ–å¤±è´¥ï¼Ÿ

**A**: ç¡®ä¿æ•°æ®åº“ä¸­æœ‰æ•°æ®

```python
from milvus_client import MyMilvusClient

client = MyMilvusClient(db_name='test1017')
result = client.query(
    'jp_knowledge_qa',
    filter_expr="id > 0",
    output_fields=["id"],
    limit=1
)
print(f"æ•°æ®åº“è®°å½•æ•°: {len(result)}")
```

å¦‚æœä¸ºç©ºï¼Œé‡æ–°è¿è¡Œï¼š
```bash
python build_knowledge_base.py
```

### Q3ï¼šæ··åˆæœç´¢å¤±è´¥é™çº§ä¸ºæ™®é€šæœç´¢ï¼Ÿ

**A**: è¿™æ˜¯æ­£å¸¸çš„é™çº§ç­–ç•¥ã€‚å¯èƒ½åŸå› ï¼š
1. ç¨€ç–å‘é‡å­—æ®µä¸å­˜åœ¨ï¼ˆæ—§æ•°æ®åº“ï¼‰
2. BM25æ¨¡å‹æœªåˆå§‹åŒ–
3. Milvusç‰ˆæœ¬ä¸æ”¯æŒæ··åˆæœç´¢

è§£å†³æ–¹æ³•ï¼š
```bash
python build_knowledge_base.py
```

### Q4ï¼šå†…å­˜å ç”¨è¿‡é«˜ï¼Ÿ

**A**: å‡å°‘æ¨¡å‹åŠ è½½æˆ–ä½¿ç”¨CPUæ¨ç†

```python
# ä½¿ç”¨è¾ƒå°çš„é‡æ’æ¨¡å‹
self.reranker = FlagReranker('BAAI/bge-reranker-base', use_fp16=True)

# ç¦ç”¨fp16ï¼ˆä½¿ç”¨CPUï¼‰
self.reranker = FlagReranker('BAAI/bge-reranker-v2-m3', use_fp16=False)
```

### Q5ï¼šå¦‚ä½•è°ƒæ•´æ£€ç´¢å‚æ•°ï¼Ÿ

**A**: æ ¹æ®éœ€æ±‚é€‰æ‹©é…ç½®

```python
# è¿½æ±‚é€Ÿåº¦
hybrid_top_k=20, final_top_k=3

# è¿½æ±‚è´¨é‡
hybrid_top_k=60, final_top_k=8
```

### Q6ï¼šä¸ºä»€ä¹ˆé€‰æ‹©40å’Œ5è¿™ä¸¤ä¸ªæ•°å­—ï¼Ÿ

**A**: ç»è¿‡æµ‹è¯•å’Œæƒè¡¡ï¼š
- **40ä¸ªå€™é€‰**ï¼šè¶³å¤Ÿé«˜çš„å¬å›ç‡ï¼ˆ~85%ï¼‰ï¼ŒåŒæ—¶é‡æ’é€Ÿåº¦å¯æ¥å—
- **5ä¸ªç»“æœ**ï¼šæä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåˆä¸ä¼šè®©LLMå›°æƒ‘

---

## ğŸ“¡ APIæ–‡æ¡£

### RAGSystem ç±»

#### åˆå§‹åŒ–

```python
rag = RAGSystem(
    db_name='test1017',              # æ•°æ®åº“åç§°
    collection_name='jp_knowledge_qa' # é›†åˆåç§°
)
```

#### retrieve() - å®Œæ•´æ£€ç´¢æµç¨‹

```python
results = rag.retrieve(
    query="æŸ¥è¯¢é—®é¢˜",                # å¿…å¡«ï¼šæŸ¥è¯¢æ–‡æœ¬
    subject_filter=None,             # å­¦ç§‘è¿‡æ»¤ï¼šNone, "Pythonå­¦ç§‘", "JAVAå­¦ç§‘"
    hybrid_top_k=40,                 # æ··åˆæœç´¢å€™é€‰æ•°é‡
    final_top_k=5                    # é‡æ’åæœ€ç»ˆæ•°é‡
)
```

**è¿”å›å€¼**ï¼šæ£€ç´¢ç»“æœåˆ—è¡¨ï¼Œæ¯ä¸ªç»“æœåŒ…å«ï¼š
- `id`: è®°å½•ID
- `subject`: å­¦ç§‘åç§°
- `question`: é—®é¢˜å†…å®¹
- `answer`: ç­”æ¡ˆå†…å®¹
- `score`: é‡æ’å¾—åˆ†ï¼ˆ0-1ï¼Œè¶Šé«˜è¶Šç›¸å…³ï¼‰

#### answer() - å®Œæ•´é—®ç­”

```python
answer = rag.answer(
    question="ç”¨æˆ·é—®é¢˜",              # å¿…å¡«ï¼šé—®é¢˜æ–‡æœ¬
    subject_filter=None,             # å­¦ç§‘è¿‡æ»¤
    hybrid_top_k=40,                 # æ··åˆæœç´¢å€™é€‰æ•°
    final_top_k=5,                   # æœ€ç»ˆç»“æœæ•°
    stream=False,                    # æµå¼è¾“å‡º
    show_context=True,               # æ˜¾ç¤ºæ£€ç´¢ä¸Šä¸‹æ–‡
    temperature=0.7                  # LLMæ¸©åº¦
)
```

#### chat() - äº¤äº’æ¨¡å¼

```python
rag.chat()  # å¯åŠ¨äº¤äº’å¼é—®ç­”ç•Œé¢
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0 (2025-10-17) - æ··åˆæœç´¢+é‡æ’åº

**é‡å¤§æ›´æ–°**ï¼š

âœ¨ **æ–°å¢åŠŸèƒ½**ï¼š
- æ··åˆæœç´¢ï¼šç¨ å¯†å‘é‡ + BM25ç¨€ç–å‘é‡ï¼ˆå¬å›40ä¸ªå€™é€‰ï¼‰
- é‡æ’åºï¼šbge-reranker-v2-m3æ¨¡å‹ï¼ˆç²¾é€‰Top5ï¼‰
- æ–°æ•°æ®åº“ï¼štest1017ï¼ˆæ”¯æŒç¨€ç–å‘é‡ï¼‰

ğŸ“ **æ–‡ä»¶å˜æ›´**ï¼š
- `requirements.txt`ï¼šæ–°å¢ rank-bm25, FlagEmbedding, jieba
- `milvus_client.py`ï¼šæ–°å¢ hybrid_search() æ–¹æ³•
- `build_knowledge_base.py`ï¼šå®Œå…¨é‡å†™ï¼Œæ”¯æŒæ··åˆæœç´¢æ•°æ®æ„å»º
- `rag_system.py`ï¼šå®Œå…¨é‡å†™ï¼Œå®ç°ä¸¤é˜¶æ®µæ£€ç´¢æµç¨‹

ğŸ“Š **æ€§èƒ½æå‡**ï¼š
- å¬å›ç‡ï¼š+30%ï¼ˆ65% â†’ 85%ï¼‰
- å‡†ç¡®ç‡ï¼š+35%ï¼ˆ70% â†’ 95%ï¼‰
- ç­”æ¡ˆè´¨é‡ï¼šæ˜¾è‘—æå‡

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
- é¦–æ¬¡è¿è¡Œéœ€ä¸‹è½½é‡æ’æ¨¡å‹ï¼ˆçº¦2GBï¼‰
- å†…å­˜å ç”¨å¢åŠ çº¦3-4GB
- APIå‚æ•°æœ‰å˜åŒ–ï¼ˆ`top_k` â†’ `hybrid_top_k`, `final_top_k`ï¼‰

### v1.0 (2025-10-16) - åˆå§‹ç‰ˆæœ¬

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- åŸºäºMilvusçš„å‘é‡æ£€ç´¢
- Qwen3-Embedding-0.6Bç”Ÿæˆè¯­ä¹‰å‘é‡
- DeepSeek LLMç”Ÿæˆç­”æ¡ˆ
- æ”¯æŒå­¦ç§‘è¿‡æ»¤
- äº¤äº’å¼é—®ç­”ç•Œé¢

---

## ğŸ”§ é…ç½®è¯´æ˜

### config.py

```python
# LLMé…ç½®
MODEL = "deepseek-chat"                  # æ¨¡å‹åç§°
BASE_URL = "https://api.deepseek.com"   # APIåŸºç¡€URL
API_KEY = "your-api-key"                 # APIå¯†é’¥

# Milvusé…ç½®
MILVUS_HOST = "YOUR_MILVUS_HOST"         # MilvusæœåŠ¡å™¨åœ°å€
MILVUS_PORT = "19530"                   # Milvusç«¯å£
```

### æ€§èƒ½å‚æ•°

```python
# Embeddingç”Ÿæˆæ‰¹é‡å¤§å°
embedding_batch_size = 32

# æ•°æ®æ’å…¥æ‰¹é‡å¤§å°
insert_batch_size = 50

# æ··åˆæœç´¢å‚æ•°
hybrid_top_k = 40                        # å€™é€‰æ•°é‡
final_top_k = 5                          # æœ€ç»ˆç»“æœæ•°

# LLMç”Ÿæˆå‚æ•°
temperature = 0.7                        # æ¸©åº¦
max_tokens = 2000                        # æœ€å¤§tokenæ•°
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
d:\py\rag_test\rag_test\
â”œâ”€â”€ æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ rag_system.py              # RAGä¸»ç³»ç»Ÿï¼ˆæ··åˆæœç´¢+é‡æ’ï¼‰
â”‚   â”œâ”€â”€ build_knowledge_base.py    # çŸ¥è¯†åº“æ„å»ºï¼ˆæ”¯æŒç¨€ç–å‘é‡ï¼‰
â”‚   â”œâ”€â”€ milvus_client.py           # Milvuså®¢æˆ·ç«¯å°è£…
â”‚   â”œâ”€â”€ prompt_templates.py        # æç¤ºè¯æ¨¡æ¿åº“
â”‚   â””â”€â”€ config.py                  # é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ æ•°æ®å’Œä¾èµ–
â”‚   â”œâ”€â”€ data/JPå­¦ç§‘çŸ¥è¯†é—®ç­”.csv    # åŸå§‹æ•°æ®ï¼ˆ467æ¡ï¼‰
â”‚   â””â”€â”€ requirements.txt           # ä¾èµ–åˆ—è¡¨
â”‚
â””â”€â”€ æ–‡æ¡£
    â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [Milvus](https://milvus.io/) - å‘é‡æ•°æ®åº“
- [Sentence Transformers](https://www.sbert.net/) - Embeddingæ¨¡å‹
- [DeepSeek](https://www.deepseek.com/) - å¤§è¯­è¨€æ¨¡å‹
- [Qwen](https://github.com/QwenLM) - Embeddingæ¨¡å‹
- [rank-bm25](https://github.com/dorianbrown/rank_bm25) - BM25ç®—æ³•
- [FlagEmbedding](https://github.com/FlagOpen/FlagEmbedding) - é‡æ’æ¨¡å‹
- [jieba](https://github.com/fxsjy/jieba) - ä¸­æ–‡åˆ†è¯

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

---

<div align="center">

**ç‰ˆæœ¬**: v2.0  
**å‘å¸ƒæ—¥æœŸ**: 2025-10-17  
**æœ€åæ›´æ–°**: 2025-10-17

**ğŸŠ ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼**

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªâ­ï¸æ”¯æŒä¸€ä¸‹ï¼

</div>
