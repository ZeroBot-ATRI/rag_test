# JPå­¦ç§‘çŸ¥è¯†é—®ç­”ç³»ç»Ÿ - RAGæ™ºèƒ½é—®ç­”ç³»ç»Ÿ

> åŸºäº Milvus å‘é‡æ•°æ®åº“ + Qwen3-Embedding + DeepSeek LLM çš„æ™ºèƒ½çŸ¥è¯†é—®ç­”ç³»ç»Ÿ

## ğŸ“š ç›®å½•

- [ç³»ç»Ÿç®€ä»‹](#ç³»ç»Ÿç®€ä»‹)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æç¤ºè¯å·¥ç¨‹](#æç¤ºè¯å·¥ç¨‹)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [é—®é¢˜æ’æŸ¥](#é—®é¢˜æ’æŸ¥)

---

## ğŸ¯ ç³»ç»Ÿç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº**æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰**æŠ€æœ¯çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼ŒåŒ…å«467æ¡Pythonå’ŒJAVAå­¦ç§‘çš„ç¼–ç¨‹çŸ¥è¯†é—®ç­”ã€‚ç³»ç»Ÿç»“åˆäº†ï¼š

- **å‘é‡æ•°æ®åº“ï¼ˆMilvusï¼‰**ï¼šé«˜æ•ˆçš„å‘é‡å­˜å‚¨å’Œæ£€ç´¢
- **Embeddingæ¨¡å‹ï¼ˆQwen3-Embedding-0.6Bï¼‰**ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸º1024ç»´è¯­ä¹‰å‘é‡
- **å¤§è¯­è¨€æ¨¡å‹ï¼ˆDeepSeekï¼‰**ï¼šç”Ÿæˆé«˜è´¨é‡çš„è‡ªç„¶è¯­è¨€å›ç­”

### æ•°æ®ç»Ÿè®¡

- **æ€»æ•°æ®é‡**: 467æ¡é—®ç­”
- **Pythonå­¦ç§‘**: 309æ¡ï¼ˆ66.2%ï¼‰
- **JAVAå­¦ç§‘**: 158æ¡ï¼ˆ33.8%ï¼‰
- **å‘é‡ç»´åº¦**: 1024ç»´

---

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½æ£€ç´¢
- âœ… åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ï¼Œè€Œéç®€å•å…³é”®è¯åŒ¹é…
- âœ… æ”¯æŒå­¦ç§‘ç­›é€‰ï¼ˆPython/JAVAï¼‰
- âœ… å¯è°ƒèŠ‚ç›¸ä¼¼åº¦é˜ˆå€¼

### 2. ä¸Šä¸‹æ–‡å¢å¼º
- âœ… å°†æ£€ç´¢åˆ°çš„çŸ¥è¯†ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæå‡å›ç­”å‡†ç¡®æ€§
- âœ… å‡å°‘LLMå¹»è§‰ï¼ŒåŸºäºå®é™…çŸ¥è¯†åº“å›ç­”
- âœ… å¯è¿½æº¯ç­”æ¡ˆæ¥æº

### 3. çµæ´»è¾“å‡º
- âœ… æ”¯æŒæµå¼/éæµå¼ä¸¤ç§è¾“å‡ºæ¨¡å¼
- âœ… 7ç§ä¸“ä¸šæç¤ºè¯æ¨¡æ¿
- âœ… å¯è‡ªå®šä¹‰æ¸©åº¦å’Œç”Ÿæˆé•¿åº¦

### 4. äº¤äº’å‹å¥½
- âœ… å‘½ä»¤è¡Œäº¤äº’å¼é—®ç­”
- âœ… å®æ—¶æ˜¾ç¤ºæ£€ç´¢ä¸Šä¸‹æ–‡
- âœ… ç®€æ´æ¸…æ™°çš„è¾“å‡ºæ ¼å¼

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·æé—®
    â†“
[1] Embeddingç¼–ç ï¼ˆQwen3-Embedding-0.6Bï¼‰
    â†“
[2] å‘é‡æ£€ç´¢ï¼ˆMilvusï¼‰
    â†“
[3] ç›¸ä¼¼åº¦ç­›é€‰ + å­¦ç§‘è¿‡æ»¤
    â†“
[4] ä¸Šä¸‹æ–‡æ ¼å¼åŒ–
    â†“
[5] æç¤ºè¯ç»„è£…ï¼ˆSystem + User Promptï¼‰
    â†“
[6] LLMç”Ÿæˆå›ç­”ï¼ˆDeepSeekï¼‰
    â†“
[7] æµå¼/éæµå¼è¾“å‡º
    â†“
è¿”å›ç­”æ¡ˆ
```

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬/è¯´æ˜ |
|------|------|-----------|
| **å‘é‡æ•°æ®åº“** | Milvus | 2.xï¼Œéƒ¨ç½²åœ¨ äº‘æœåŠ¡å™¨ |
| **Embeddingæ¨¡å‹** | Qwen3-Embedding-0.6B | é˜¿é‡Œé€šä¹‰åƒé—®ï¼Œ1024ç»´è¾“å‡º |
| **å¤§è¯­è¨€æ¨¡å‹** | DeepSeek | deepseek-chat |
| **å‘é‡æ£€ç´¢åº“** | pymilvus | Pythonå®¢æˆ·ç«¯ |
| **æ¨¡å‹åŠ è½½** | sentence-transformers | Hugging Face |
| **æ•°æ®å¤„ç†** | pandas, numpy | æ•°æ®æ¸…æ´—å’Œå¤„ç† |

### æ•°æ®åº“ç»“æ„

**æ•°æ®åº“åç§°**: `test1016`  
**é›†åˆåç§°**: `jp_knowledge_qa`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INT64 | ä¸»é”®IDï¼ˆ1-467ï¼‰ |
| vector | FLOAT_VECTOR(1024) | é—®é¢˜çš„å‘é‡è¡¨ç¤º |
| subject | VARCHAR | å­¦ç§‘åç§°ï¼ˆåŠ¨æ€å­—æ®µï¼‰ |
| question | VARCHAR | é—®é¢˜å†…å®¹ï¼ˆåŠ¨æ€å­—æ®µï¼‰ |
| answer | VARCHAR | ç­”æ¡ˆå†…å®¹ï¼ˆåŠ¨æ€å­—æ®µï¼‰ |
| timestamp | INT64 | æ’å…¥æ—¶é—´æˆ³ï¼ˆåŠ¨æ€å­—æ®µï¼‰ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

#### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–ï¼š
- `pandas` - æ•°æ®å¤„ç†
- `sentence-transformers` - Embeddingæ¨¡å‹
- `pymilvus` - Milvuså®¢æˆ·ç«¯
- `openai>=1.0.0` - LLMå®¢æˆ·ç«¯
- `tqdm` - è¿›åº¦æ¡æ˜¾ç¤º
- `numpy` - æ•°å€¼è®¡ç®—

#### é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config.py`ï¼Œå¡«å…¥æ‚¨çš„APIé…ç½®ï¼š

```python
MODEL = "deepseek-chat"
BASE_URL = "https://api.deepseek.com"
API_KEY = "your-api-key-here"  # æ›¿æ¢ä¸ºæ‚¨çš„API Key
MILVUS_URL = "your-milvus-url-here"
```

### 2. æ„å»ºçŸ¥è¯†åº“ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰

```bash
python build_knowledge_base.py
```

æ‰§è¡Œæµç¨‹ï¼š
1. åŠ è½½Qwen3-Embedding-0.6Bæ¨¡å‹ï¼ˆé¦–æ¬¡ä¼šä¸‹è½½ï¼Œçº¦2GBï¼‰
2. åˆ›å»ºMilvusé›†åˆï¼ˆ1024ç»´å‘é‡ï¼‰
3. è¯»å–CSVæ•°æ®æ–‡ä»¶ï¼ˆ467æ¡ï¼‰
4. ç”Ÿæˆé—®é¢˜å‘é‡ï¼ˆæ‰¹é‡å¤„ç†ï¼Œbatch_size=32ï¼‰
5. æ’å…¥å‘é‡æ•°æ®åº“ï¼ˆæ‰¹é‡æ’å…¥ï¼Œbatch_size=50ï¼‰
6. éªŒè¯æ•°æ®å®Œæ•´æ€§
7. æµ‹è¯•å‘é‡æœç´¢åŠŸèƒ½

**é¢„æœŸè¾“å‡º**ï¼š
```
================================================================================
çŸ¥è¯†åº“æ„å»ºç³»ç»Ÿ
================================================================================
æ­£åœ¨åŠ è½½Embeddingæ¨¡å‹...
æ¨¡å‹åŠ è½½å®Œæˆï¼
æ­£åœ¨åˆ›å»ºé›†åˆ jp_knowledge_qa...
é›†åˆ jp_knowledge_qa åˆ›å»ºæˆåŠŸï¼
...
æ•°æ®æ’å…¥å®Œæˆï¼æˆåŠŸæ’å…¥ 467/467 æ¡æ•°æ®
```

### 3. è¿è¡ŒRAGç³»ç»Ÿ

```bash
python rag_system.py
```

ç³»ç»Ÿä¼šï¼š
1. åˆå§‹åŒ–å‘é‡æ•°æ®åº“å’ŒLLM
2. è¿è¡Œç¤ºä¾‹é—®ç­”
3. è¯¢é—®æ˜¯å¦è¿›å…¥äº¤äº’æ¨¡å¼

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### äº¤äº’å¼é—®ç­”

è¿è¡Œ `python rag_system.py` åï¼Œé€‰æ‹©è¿›å…¥äº¤äº’æ¨¡å¼ï¼š

```
ğŸ’¬ æ‚¨çš„é—®é¢˜: å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨è®¡ç®—å‡½æ•°è¿è¡Œæ—¶é—´ï¼Ÿ

[1/3] æ­£åœ¨æ£€ç´¢ç›¸å…³çŸ¥è¯†...
âœ“ æ‰¾åˆ° 2 æ¡ç›¸å…³å‚è€ƒèµ„æ–™

--------------------------------------------------------------------------------
æ£€ç´¢åˆ°çš„å‚è€ƒèµ„æ–™ï¼š
--------------------------------------------------------------------------------
ã€1ã€‘ç›¸ä¼¼åº¦: 72.27%
å­¦ç§‘ï¼šPythonå­¦ç§‘
é—®é¢˜ï¼šç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å®ç°å‡½æ•°è¿è¡Œæ—¶é—´çš„è®¡ç®—?...

ã€2ã€‘ç›¸ä¼¼åº¦: 58.03%
å­¦ç§‘ï¼šPythonå­¦ç§‘
é—®é¢˜ï¼šè£…é¥°å™¨ç»ƒä¹ é¢˜...
--------------------------------------------------------------------------------

[2/3] æ­£åœ¨ç”Ÿæˆå›ç­”...

[3/3] å›ç­”å†…å®¹ï¼š
================================================================================
ï¼ˆLLMåŸºäºæ£€ç´¢ä¸Šä¸‹æ–‡ç”Ÿæˆçš„è¯¦ç»†å›ç­”ï¼‰
================================================================================
```

### äº¤äº’å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ |
|------|------|
| ç›´æ¥è¾“å…¥é—®é¢˜ | è¿›è¡Œæé—® |
| `/python` | é™å®šPythonå­¦ç§‘ |
| `/java` | é™å®šJAVAå­¦ç§‘ |
| `/clear` | æ¸…é™¤å­¦ç§‘é™å®š |
| `/stream` | åˆ‡æ¢æµå¼/éæµå¼è¾“å‡º |
| `/context` | åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºå‚è€ƒèµ„æ–™ |
| `quit` æˆ– `exit` | é€€å‡ºç³»ç»Ÿ |

### Python APIä½¿ç”¨

```python
from rag_system import RAGSystem

# åˆå§‹åŒ–ç³»ç»Ÿ
rag = RAGSystem()

# å•æ¬¡é—®ç­”
answer = rag.answer(
    question="å¦‚ä½•ä½¿ç”¨Pythonè£…é¥°å™¨ï¼Ÿ",
    subject_filter=None,      # å¯é€‰ï¼šNone, "Pythonå­¦ç§‘", "JAVAå­¦ç§‘"
    top_k=3,                   # æ£€ç´¢å‰3ä¸ªç»“æœ
    stream=False,              # éæµå¼è¾“å‡º
    show_context=True,         # æ˜¾ç¤ºæ£€ç´¢ä¸Šä¸‹æ–‡
    temperature=0.7            # LLMæ¸©åº¦å‚æ•°
)

# äº¤äº’æ¨¡å¼
rag.chat()

# ä»…æ£€ç´¢ï¼ˆä¸è°ƒç”¨LLMï¼‰
results = rag.retrieve(
    query="è£…é¥°å™¨",
    top_k=3,
    subject_filter="Pythonå­¦ç§‘",
    similarity_threshold=0.7
)
```

---

## ğŸ¨ æç¤ºè¯å·¥ç¨‹

### æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ

ç³»ç»Ÿæä¾›äº†7ç§ä¸“ä¸šçš„æç¤ºè¯æ¨¡æ¿ï¼ˆå®šä¹‰åœ¨ `prompt_templates.py`ï¼‰ï¼š

| æ¨¡å¼ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|
| **default** | é€šç”¨é—®ç­” | å¹³è¡¡å‡†ç¡®æ€§å’Œè¯¦ç»†åº¦ |
| **strict** | ç²¾ç¡®å›ç­” | ä»…ä½¿ç”¨çŸ¥è¯†åº“ï¼Œä¸æ·»åŠ é¢å¤–ä¿¡æ¯ |
| **teaching** | æ•™å­¦è¾…å¯¼ | è¯¦ç»†è§£é‡Šï¼Œå¾ªåºæ¸è¿› |
| **concise** | å¿«é€ŸæŸ¥è¯¢ | ç®€æ´æ˜äº†ï¼Œé‡ç‚¹çªå‡º |
| **debug** | é—®é¢˜è¯Šæ–­ | åˆ†æåŸå› ï¼Œæä¾›è§£å†³æ–¹æ¡ˆ |
| **comparison** | æ–¹æ¡ˆå¯¹æ¯” | å¤šæ–¹æ¡ˆæ¯”è¾ƒåˆ†æ |
| **code_review** | ä»£ç å®¡æŸ¥ | å…³æ³¨ä»£ç è´¨é‡å’Œæœ€ä½³å®è·µ |

### é»˜è®¤æç¤ºè¯æ¨¡æ¿

#### ç³»ç»Ÿæç¤ºè¯ï¼ˆå®šä¹‰AIè§’è‰²ï¼‰

```python
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹å­¦ä¹ åŠ©æ‰‹ï¼Œä¸“æ³¨äºPythonå’ŒJAVAæŠ€æœ¯é—®ç­”ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„çŸ¥è¯†åº“å†…å®¹ï¼Œä¸ºç”¨æˆ·æä¾›å‡†ç¡®ã€è¯¦ç»†ã€æ˜“æ‡‚çš„æŠ€æœ¯è§£ç­”ã€‚

å›ç­”è¦æ±‚ï¼š
1. åŸºäºæä¾›çš„å‚è€ƒèµ„æ–™å›ç­”é—®é¢˜ï¼Œä¿æŒå‡†ç¡®æ€§
2. å¦‚æœå‚è€ƒèµ„æ–™ä¸­æœ‰ä»£ç ç¤ºä¾‹ï¼Œè¯·å®Œæ•´å±•ç¤º
3. ç”¨æ¸…æ™°çš„è¯­è¨€è§£é‡ŠæŠ€æœ¯æ¦‚å¿µ
4. å¦‚æœå‚è€ƒèµ„æ–™ä¸å¤Ÿå……åˆ†ï¼Œå¯ä»¥é€‚å½“è¡¥å……ä½ çš„çŸ¥è¯†ï¼Œä½†è¦æ˜ç¡®è¯´æ˜
5. ä¿æŒä¸“ä¸šã€å‹å¥½çš„è¯­æ°”
6. ä½¿ç”¨Markdownæ ¼å¼ç»„ç»‡ç­”æ¡ˆï¼Œæå‡å¯è¯»æ€§
"""
```

#### ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ï¼ˆæ³¨å…¥ä¸Šä¸‹æ–‡ï¼‰

```python
USER_PROMPT_TEMPLATE = """ç”¨æˆ·é—®é¢˜ï¼š{question}

å‚è€ƒèµ„æ–™ï¼ˆæ¥è‡ªçŸ¥è¯†åº“ï¼‰ï¼š
{context}

è¯·åŸºäºä»¥ä¸Šå‚è€ƒèµ„æ–™å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœå‚è€ƒèµ„æ–™å·²ç»åŒ…å«å®Œæ•´ç­”æ¡ˆï¼Œè¯·ç›´æ¥ä½¿ç”¨ï¼›å¦‚æœéœ€è¦è¡¥å……è¯´æ˜ï¼Œè¯·åœ¨ä¿æŒå‡†ç¡®æ€§çš„å‰æä¸‹é€‚å½“å±•å¼€ã€‚
"""
```

### è‡ªå®šä¹‰æç¤ºè¯

#### æ–¹æ³•1ï¼šä½¿ç”¨é¢„å®šä¹‰æ¨¡æ¿

```python
from prompt_templates import TemplateSelector

# åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å¼
print(TemplateSelector.list_modes())
# ['default', 'strict', 'teaching', 'concise', 'debug', 'comparison', 'code_review']

# è·å–ç‰¹å®šæ¨¡å¼çš„æ¨¡æ¿
system_prompt, user_prompt = TemplateSelector.get_template('teaching')
```

#### æ–¹æ³•2ï¼šç›´æ¥ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶

ç¼–è¾‘ `prompt_templates.py`ï¼Œæ·»åŠ æ‚¨è‡ªå·±çš„æ¨¡æ¿ï¼š

```python
# æ·»åŠ æ–°æ¨¡æ¿
CUSTOM_SYSTEM = """ä½ çš„ç³»ç»Ÿæç¤ºè¯..."""
CUSTOM_USER = """ç”¨æˆ·é—®é¢˜ï¼š{question}..."""

# æ³¨å†Œåˆ°é€‰æ‹©å™¨
TemplateSelector.MODES['custom'] = (CUSTOM_SYSTEM, CUSTOM_USER)
```

#### æ–¹æ³•3ï¼šåœ¨ä»£ç ä¸­åŠ¨æ€ä¿®æ”¹

ä¿®æ”¹ `rag_system.py` ä¸­çš„ `PromptTemplate` ç±»ï¼š

```python
class PromptTemplate:
    SYSTEM_PROMPT = """ä½ çš„è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯..."""
    USER_PROMPT_TEMPLATE = """ä½ çš„è‡ªå®šä¹‰ç”¨æˆ·æ¨¡æ¿..."""
```

### æç¤ºè¯è®¾è®¡æœ€ä½³å®è·µ

#### âœ… å¥½çš„æç¤ºè¯è®¾è®¡

1. **æ˜ç¡®è§’è‰²å®šä¹‰**
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Pythonç¼–ç¨‹å¯¼å¸ˆï¼Œæœ‰10å¹´çš„æ•™å­¦ç»éªŒ...
```

2. **æ¸…æ™°çš„ä»»åŠ¡è¯´æ˜**
```
ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. åŸºäºæä¾›çš„å‚è€ƒèµ„æ–™å›ç­”é—®é¢˜
2. å¦‚æœå‚è€ƒèµ„æ–™å……åˆ†ï¼Œä¼˜å…ˆä½¿ç”¨
3. å¿…è¦æ—¶è¡¥å……ï¼Œä½†è¦æ˜ç¡®æ ‡æ³¨
```

3. **å…·ä½“çš„æ ¼å¼è¦æ±‚**
```
è¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
1. æ¦‚å¿µè§£é‡Šï¼ˆæ˜¯ä»€ä¹ˆï¼‰
2. ä½¿ç”¨æ–¹æ³•ï¼ˆæ€ä¹ˆåšï¼‰
3. ä»£ç ç¤ºä¾‹
4. æ³¨æ„äº‹é¡¹
```

#### âŒ é¿å…çš„é—®é¢˜

- æ¨¡ç³Šçš„è§’è‰²å®šä¹‰ï¼š"ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹..."
- ä¸æ˜ç¡®çš„ä»»åŠ¡ï¼š"è¯·å›ç­”é—®é¢˜..."
- ç¼ºä¹æ ¼å¼çº¦æŸï¼š"è¯·è¯¦ç»†å›ç­”..."

---

## ğŸ“¡ APIæ–‡æ¡£

### RAGSystem ç±»

#### åˆå§‹åŒ–

```python
rag = RAGSystem(
    db_name='test1016',              # æ•°æ®åº“åç§°
    collection_name='jp_knowledge_qa' # é›†åˆåç§°
)
```

#### retrieve() - å‘é‡æ£€ç´¢

```python
results = rag.retrieve(
    query="æŸ¥è¯¢é—®é¢˜",                # å¿…å¡«ï¼šæŸ¥è¯¢æ–‡æœ¬
    top_k=3,                         # è¿”å›å‰Nä¸ªç»“æœ
    subject_filter="Pythonå­¦ç§‘",      # å­¦ç§‘è¿‡æ»¤ï¼šNone, "Pythonå­¦ç§‘", "JAVAå­¦ç§‘"
    similarity_threshold=0.7          # ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼Œè·ç¦»é˜ˆå€¼ï¼‰
)
```

**è¿”å›å€¼**: æ£€ç´¢ç»“æœåˆ—è¡¨ï¼Œæ¯ä¸ªç»“æœåŒ…å«ï¼š
- `id`: è®°å½•ID
- `subject`: å­¦ç§‘åç§°
- `question`: é—®é¢˜å†…å®¹
- `answer`: ç­”æ¡ˆå†…å®¹
- `distance`: å‘é‡è·ç¦»ï¼ˆè¶Šå°è¶Šç›¸ä¼¼ï¼‰

#### generate() - LLMç”Ÿæˆ

```python
answer = rag.generate(
    messages=messages,     # å¯¹è¯æ¶ˆæ¯åˆ—è¡¨
    stream=False,          # æ˜¯å¦æµå¼è¾“å‡º
    temperature=0.7,       # æ¸©åº¦å‚æ•°ï¼ˆ0-1ï¼‰
    max_tokens=2000        # æœ€å¤§ç”Ÿæˆtokenæ•°
)
```

**æ¸©åº¦å‚æ•°è¯´æ˜**:
- `0.0-0.3`: ç¡®å®šæ€§å¼ºï¼Œé€‚åˆæŠ€æœ¯é—®ç­”
- `0.4-0.7`: å¹³è¡¡åˆ›é€ æ€§å’Œå‡†ç¡®æ€§ï¼ˆæ¨èï¼‰
- `0.8-1.0`: æ›´æœ‰åˆ›é€ æ€§ï¼Œé€‚åˆåˆ›æ„å†…å®¹

#### answer() - å®Œæ•´é—®ç­”

```python
answer = rag.answer(
    question="ç”¨æˆ·é—®é¢˜",              # å¿…å¡«ï¼šé—®é¢˜æ–‡æœ¬
    subject_filter=None,             # å­¦ç§‘è¿‡æ»¤
    top_k=3,                         # æ£€ç´¢æ•°é‡
    stream=True,                     # æµå¼è¾“å‡º
    show_context=True,               # æ˜¾ç¤ºæ£€ç´¢ä¸Šä¸‹æ–‡
    temperature=0.7                  # LLMæ¸©åº¦
)
```

#### chat() - äº¤äº’æ¨¡å¼

```python
rag.chat()  # å¯åŠ¨äº¤äº’å¼é—®ç­”ç•Œé¢
```

### PromptTemplate ç±»

#### create_messages() - åˆ›å»ºå¯¹è¯æ¶ˆæ¯

```python
from rag_system import PromptTemplate

messages = PromptTemplate.create_messages(
    question="ç”¨æˆ·é—®é¢˜",
    context="æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡"
)
```

#### format_context() - æ ¼å¼åŒ–ä¸Šä¸‹æ–‡

```python
context = PromptTemplate.format_context(
    search_results,    # æ£€ç´¢ç»“æœåˆ—è¡¨
    max_results=3      # æœ€å¤šä½¿ç”¨çš„ç»“æœæ•°
)
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### config.py

```python
# LLMé…ç½®
MODEL = "deepseek-chat"                  # æ¨¡å‹åç§°
BASE_URL = "https://api.deepseek.com"   # APIåŸºç¡€URL
API_KEY = "your-api-key"                 # APIå¯†é’¥

# Milvusé…ç½®
MILVUS_URL = "your-milvus-url"          # MilvusæœåŠ¡å™¨åœ°å€
```

### ç³»ç»Ÿå‚æ•°

åœ¨ `build_knowledge_base.py` ä¸­ï¼š

```python
DB_NAME = 'test1016'                    # æ•°æ®åº“å
COLLECTION_NAME = 'jp_knowledge_qa'     # é›†åˆå
VECTOR_DIM = 1024                       # å‘é‡ç»´åº¦
CSV_PATH = 'data/JPå­¦ç§‘çŸ¥è¯†é—®ç­”.csv'     # æ•°æ®æºè·¯å¾„
```

### æ€§èƒ½å‚æ•°

```python
# Embeddingç”Ÿæˆæ‰¹é‡å¤§å°
embedding_batch_size = 32

# æ•°æ®æ’å…¥æ‰¹é‡å¤§å°
insert_batch_size = 50

# æ£€ç´¢å‚æ•°
top_k = 3                              # æ£€ç´¢ç»“æœæ•°é‡
similarity_threshold = 0.7             # ç›¸ä¼¼åº¦é˜ˆå€¼

# LLMç”Ÿæˆå‚æ•°
temperature = 0.7                      # æ¸©åº¦
max_tokens = 2000                      # æœ€å¤§tokenæ•°
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ£€ç´¢ç­–ç•¥

#### ç›¸ä¼¼åº¦é˜ˆå€¼è°ƒæ•´

```python
# ä¸¥æ ¼æ¨¡å¼ï¼šåªè¿”å›é«˜åº¦ç›¸å…³çš„ç»“æœ
results = rag.retrieve(query, similarity_threshold=0.8)

# å¹³è¡¡æ¨¡å¼ï¼šæ¨èä½¿ç”¨
results = rag.retrieve(query, similarity_threshold=0.7)

# å®½æ¾æ¨¡å¼ï¼šè¿”å›æ›´å¤šå¯èƒ½ç›¸å…³çš„ç»“æœ
results = rag.retrieve(query, similarity_threshold=0.5)
```

#### æ£€ç´¢æ•°é‡ä¼˜åŒ–

```python
# ç²¾ç¡®å›ç­”ï¼š1-2æ¡æœ€ç›¸å…³
rag.answer(question, top_k=2)

# ç»¼åˆå›ç­”ï¼š3-5æ¡ï¼ˆæ¨èï¼‰
rag.answer(question, top_k=3)

# æ¢ç´¢å¼å›ç­”ï¼šæ›´å¤šå†…å®¹
rag.answer(question, top_k=10)
```

#### å­¦ç§‘ç­›é€‰ç­–ç•¥

```python
# ç²¾å‡†ç­›é€‰ï¼šæ˜ç¡®å­¦ç§‘
rag.answer(question, subject_filter="Pythonå­¦ç§‘")

# æ··åˆæ£€ç´¢ï¼šä¸é™å­¦ç§‘ï¼Œè®©LLMç»¼åˆåˆ¤æ–­
rag.answer(question, subject_filter=None)
```

### 2. LLMå‚æ•°è°ƒä¼˜

#### æ¸©åº¦å‚æ•°

```python
# æŠ€æœ¯é—®ç­”ï¼šä½æ¸©åº¦ï¼Œæ›´å‡†ç¡®
rag.answer(question, temperature=0.3)

# æ¦‚å¿µè§£é‡Šï¼šä¸­ç­‰æ¸©åº¦
rag.answer(question, temperature=0.5)

# åˆ›æ„å†…å®¹ï¼šé«˜æ¸©åº¦
rag.answer(question, temperature=0.8)
```

#### Tokené™åˆ¶

```python
# ç®€çŸ­å›ç­”
rag.generate(messages, max_tokens=500)

# æ ‡å‡†å›ç­”ï¼ˆæ¨èï¼‰
rag.generate(messages, max_tokens=2000)

# è¯¦ç»†å›ç­”
rag.generate(messages, max_tokens=4000)
```

### 3. å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šæŠ€æœ¯é—®ç­”

```python
rag.answer(
    question="Pythonä¸­å¦‚ä½•å®ç°å•ä¾‹æ¨¡å¼ï¼Ÿ",
    subject_filter="Pythonå­¦ç§‘",
    top_k=3,
    temperature=0.3,  # ä½æ¸©åº¦ï¼Œæ›´å‡†ç¡®
    stream=False
)
```

#### åœºæ™¯2ï¼šæ¦‚å¿µè§£é‡Š

```python
rag.answer(
    question="ä»€ä¹ˆæ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Ÿ",
    subject_filter=None,  # ä¸é™å­¦ç§‘ï¼Œå¤šè§’åº¦è§£é‡Š
    top_k=5,
    temperature=0.5,      # å¹³è¡¡å‡†ç¡®æ€§å’Œè¡¨è¾¾
    show_context=True
)
```

#### åœºæ™¯3ï¼šä»£ç è°ƒè¯•

```python
rag.answer(
    question="ä¸ºä»€ä¹ˆæˆ‘çš„ä»£ç æŠ¥é”™ NoneType?",
    subject_filter="Pythonå­¦ç§‘",
    top_k=5,
    temperature=0.7,      # è¯¦ç»†è§£é‡Š
    show_context=True     # æ˜¾ç¤ºå‚è€ƒèµ„æ–™
)
```

### 4. æ‰¹é‡å¤„ç†

```python
questions = [
    "å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨ï¼Ÿ",
    "ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ",
    "è§£é‡ŠPythonçš„GIL"
]

for q in questions:
    print(f"\né—®é¢˜: {q}")
    answer = rag.answer(q, stream=False, show_context=False)
    print("-" * 80)
```

---

## ğŸ” é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ£€ç´¢ä¸åˆ°ç›¸å…³å†…å®¹

**ç°è±¡**ï¼š
```
[1/3] æ­£åœ¨æ£€ç´¢ç›¸å…³çŸ¥è¯†...
âœ— æœªæ‰¾åˆ°ç›¸å…³å‚è€ƒèµ„æ–™
```

**å¯èƒ½åŸå› **ï¼š
1. ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®è¿‡é«˜
2. å­¦ç§‘ç­›é€‰è¿‡äºä¸¥æ ¼
3. çŸ¥è¯†åº“ä¸­ç¡®å®æ²¡æœ‰ç›¸å…³å†…å®¹

**è§£å†³æ–¹æ³•**ï¼š

```python
# 1. é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼
rag.answer(question, similarity_threshold=0.5)

# 2. å–æ¶ˆå­¦ç§‘é™åˆ¶
rag.answer(question, subject_filter=None)

# 3. æ£€æŸ¥çŸ¥è¯†åº“
from query_knowledge_base import KnowledgeQuerySystem
kq = KnowledgeQuerySystem()
kq.stats()  # æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
```

### é—®é¢˜2ï¼šLLMè¿”å›å†…å®¹ä¸ç†æƒ³

**å¯èƒ½åŸå› **ï¼š
1. æç¤ºè¯ä¸å¤Ÿæ˜ç¡®
2. ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸è¶³
3. æ¸©åº¦å‚æ•°è®¾ç½®ä¸å½“

**è§£å†³æ–¹æ³•**ï¼š

```python
# 1. è°ƒæ•´æ¸©åº¦ï¼ˆæ›´ç¡®å®šï¼‰
rag.answer(question, temperature=0.3)

# 2. å¢åŠ æ£€ç´¢æ•°é‡
rag.answer(question, top_k=5)

# 3. åˆ‡æ¢æç¤ºè¯æ¨¡æ¿
from prompt_templates import TemplateSelector
system, user = TemplateSelector.get_template('teaching')
```

### é—®é¢˜3ï¼šå“åº”é€Ÿåº¦æ…¢

**å¯èƒ½åŸå› **ï¼š
1. ç½‘ç»œå»¶è¿Ÿ
2. max_tokensè®¾ç½®è¿‡å¤§
3. æ£€ç´¢æ•°é‡è¿‡å¤š

**è§£å†³æ–¹æ³•**ï¼š

```python
# 1. å‡å°‘max_tokens
rag.generate(messages, max_tokens=1000)

# 2. å‡å°‘æ£€ç´¢æ•°é‡
rag.answer(question, top_k=2)

# 3. ä½¿ç”¨æµå¼è¾“å‡ºæ”¹å–„ä½“éªŒ
rag.answer(question, stream=True)
```

### é—®é¢˜4ï¼šAPIè°ƒç”¨å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
1. APIå¯†é’¥é”™è¯¯
2. ç½‘ç»œè¿æ¥é—®é¢˜
3. APIé…é¢è€—å°½

**è§£å†³æ–¹æ³•**ï¼š

```python
# æ£€æŸ¥é…ç½®
import config
print(f"API Key: {config.API_KEY[:10]}...")
print(f"Base URL: {config.BASE_URL}")

# æµ‹è¯•è¿æ¥
from openai import OpenAI
client = OpenAI(api_key=config.API_KEY, base_url=config.BASE_URL)
response = client.chat.completions.create(
    model=config.MODEL,
    messages=[{"role": "user", "content": "Hi"}],
    max_tokens=10
)
print("è¿æ¥æˆåŠŸï¼")
```

### é—®é¢˜5ï¼šçŸ¥è¯†åº“æ„å»ºå¤±è´¥

**å¯èƒ½åŸå› **ï¼š
1. Milvusè¿æ¥å¤±è´¥
2. Embeddingæ¨¡å‹åŠ è½½å¤±è´¥
3. CSVæ–‡ä»¶è·¯å¾„é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š

```bash
# 1. æ£€æŸ¥Milvusè¿æ¥
python -c "from milvus_client import MyMilvusClient; client = MyMilvusClient(); print(client.list_collections())"

# 2. æ£€æŸ¥æ¨¡å‹ç¼“å­˜
ls models/

# 3. æ£€æŸ¥CSVæ–‡ä»¶
python -c "import pandas as pd; df = pd.read_csv('data/JPå­¦ç§‘çŸ¥è¯†é—®ç­”.csv'); print(len(df))"
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ£€ç´¢æ€§èƒ½

- **å‘é‡ç”Ÿæˆé€Ÿåº¦**: ~5.5 it/sï¼ˆæ‰¹é‡32ï¼‰
- **ç›¸ä¼¼åº¦æœç´¢**: æ¯«ç§’çº§
- **å¹³å‡æ£€ç´¢æ—¶é—´**: < 1ç§’

### ç”Ÿæˆæ€§èƒ½

- **LLMå“åº”æ—¶é—´**: 1-3ç§’ï¼ˆéæµå¼ï¼‰
- **æµå¼é¦–å­—æ—¶é—´**: < 0.5ç§’
- **å¹³å‡ç”Ÿæˆé€Ÿåº¦**: ~50 tokens/s

### å‡†ç¡®ç‡

- **çŸ¥è¯†åº“è¦†ç›–**: 467æ¡ï¼ˆ100%å¯¼å…¥æˆåŠŸï¼‰
- **Top-3å¬å›ç‡**: ~90%ï¼ˆç›¸ä¼¼åº¦>0.7ï¼‰
- **ç­”æ¡ˆè´¨é‡**: é«˜ï¼ˆåŸºäºå‚è€ƒèµ„æ–™ï¼‰

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
d:\py\1010\
â”œâ”€â”€ æ ¸å¿ƒç³»ç»Ÿ
â”‚   â”œâ”€â”€ rag_system.py              â­ RAGä¸»ç³»ç»Ÿï¼ˆ374è¡Œï¼‰
â”‚   â”œâ”€â”€ build_knowledge_base.py    â­ çŸ¥è¯†åº“æ„å»ºï¼ˆ237è¡Œï¼‰
â”‚   â”œâ”€â”€ query_knowledge_base.py    â­ çº¯å‘é‡æ£€ç´¢ï¼ˆ154è¡Œï¼‰
â”‚   â””â”€â”€ milvus_client.py           â­ Milvuså®¢æˆ·ç«¯å°è£…
â”‚
â”œâ”€â”€ æç¤ºè¯å’Œé…ç½®
â”‚   â”œâ”€â”€ prompt_templates.py        â­ æç¤ºè¯æ¨¡æ¿åº“ï¼ˆ284è¡Œï¼‰
â”‚   â”œâ”€â”€ config.py                  â­ APIé…ç½®
â”‚   â””â”€â”€ requirements.txt           â­ ä¾èµ–åˆ—è¡¨
â”‚
â”œâ”€â”€ æ•°æ®å’Œæ¨¡å‹
â”‚   â”œâ”€â”€ data/JPå­¦ç§‘çŸ¥è¯†é—®ç­”.csv    â­ åŸå§‹æ•°æ®ï¼ˆ467æ¡ï¼‰
â”‚   â””â”€â”€ models/                    â­ Embeddingæ¨¡å‹ç¼“å­˜
â”‚
â””â”€â”€ æ–‡æ¡£
    â””â”€â”€ README.md                  â­ æœ¬æ–‡æ¡£
```

---

## ğŸ”„ æ›´æ–°ä¸ç»´æŠ¤

### æ›´æ–°çŸ¥è¯†åº“

#### é‡å»ºçŸ¥è¯†åº“

```python
# ä¿®æ”¹ build_knowledge_base.py
builder.create_collection(dim=VECTOR_DIM, drop_if_exists=True)
```

#### å¢é‡æ·»åŠ 

```python
from milvus_client import MyMilvusClient
import time

client = MyMilvusClient(db_name='test1016')

# å‡†å¤‡æ–°æ•°æ®
new_data = [{
    "id": 468,  # æ³¨æ„IDä¸èƒ½é‡å¤
    "vector": embedding_vector.tolist(),
    "subject": "Pythonå­¦ç§‘",
    "question": "æ–°é—®é¢˜",
    "answer": "æ–°ç­”æ¡ˆ",
    "timestamp": int(time.time())
}]

# æ’å…¥
client.insert('jp_knowledge_qa', new_data)
```

### ç›‘æ§ç³»ç»Ÿ

```python
import time

# æ£€ç´¢æ€§èƒ½ç›‘æ§
start = time.time()
results = rag.retrieve(query)
print(f"æ£€ç´¢è€—æ—¶: {time.time() - start:.2f}ç§’")
print(f"æ£€ç´¢ç»“æœæ•°: {len(results)}")

# ç”Ÿæˆæ€§èƒ½ç›‘æ§
start = time.time()
answer = rag.generate(messages, stream=False)
print(f"ç”Ÿæˆè€—æ—¶: {time.time() - start:.2f}ç§’")
print(f"å›ç­”é•¿åº¦: {len(answer)}å­—ç¬¦")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Tokené™åˆ¶
- DeepSeekæ¨¡å‹æœ‰tokené™åˆ¶
- æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…è¶…é™
- å¯è°ƒæ•´ `max_tokens` å‚æ•°

### 2. APIè´¹ç”¨
- æ¯æ¬¡è°ƒç”¨LLMä¼šäº§ç”Ÿè´¹ç”¨
- åˆç†è®¾ç½® `top_k` å’Œ `max_tokens`
- è€ƒè™‘ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è°ƒç”¨

### 3. æ£€ç´¢è´¨é‡
- ç›¸ä¼¼åº¦é˜ˆå€¼å½±å“å¬å›ç‡å’Œå‡†ç¡®ç‡
- æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´é˜ˆå€¼
- å®šæœŸæ›´æ–°çŸ¥è¯†åº“æ•°æ®

### 4. æç¤ºè¯è®¾è®¡
- æ¸…æ™°æ˜ç¡®çš„æŒ‡ä»¤
- åˆé€‚çš„ä¸Šä¸‹æ–‡é•¿åº¦
- é€‚å½“çš„çº¦æŸæ¡ä»¶

### 5. å®‰å…¨æ€§
- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç APIå¯†é’¥
- ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
- æ³¨æ„æ•°æ®éšç§ä¿æŠ¤

---

## ğŸ“ å­¦ä¹ èµ„æº

### RAGç›¸å…³
- [RAGæŠ€æœ¯ç»¼è¿°](https://arxiv.org/abs/2005.11401)
- [Milvuså®˜æ–¹æ–‡æ¡£](https://milvus.io/docs)
- [Sentence Transformersæ–‡æ¡£](https://www.sbert.net/)

### æç¤ºè¯å·¥ç¨‹
- [OpenAIæç¤ºè¯å·¥ç¨‹æŒ‡å—](https://platform.openai.com/docs/guides/prompt-engineering)
- [æç¤ºè¯æœ€ä½³å®è·µ](https://www.promptingguide.ai/)

### å‘é‡æ£€ç´¢
- [å‘é‡æ£€ç´¢åŸç†](https://www.pinecone.io/learn/vector-search/)
- [EmbeddingæŠ€æœ¯è¯¦è§£](https://huggingface.co/blog/getting-started-with-embeddings)

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ã€æ–‡æ¡£æˆ–æå‡ºå»ºè®®ï¼

### æ”¹è¿›æ–¹å‘

- [ ] æ·»åŠ å¯¹è¯å†å²è®°å¿†
- [ ] æ”¯æŒå¤šè½®å¯¹è¯
- [ ] å®ç°ç­”æ¡ˆè¯„åˆ†å’Œåé¦ˆ
- [ ] æ·»åŠ Webç•Œé¢
- [ ] æ”¯æŒæ›´å¤šæ•°æ®æº
- [ ] ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿
- [ ] æ·»åŠ ç¼“å­˜æœºåˆ¶
- [ ] æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- æäº¤ Issue
- å‘é€é‚®ä»¶

---

## ğŸ‰ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [Milvus](https://milvus.io/) - å‘é‡æ•°æ®åº“
- [Sentence Transformers](https://www.sbert.net/) - Embeddingæ¨¡å‹
- [DeepSeek](https://www.deepseek.com/) - å¤§è¯­è¨€æ¨¡å‹
- [Qwen](https://github.com/QwenLM) - Embeddingæ¨¡å‹

---

**ç‰ˆæœ¬**: v1.0  
**å‘å¸ƒæ—¥æœŸ**: 2025-10-16  
**æœ€åæ›´æ–°**: 2025-10-16

---

<div align="center">

**ğŸŠ ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼**

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªâ­ï¸æ”¯æŒä¸€ä¸‹ï¼

</div>
